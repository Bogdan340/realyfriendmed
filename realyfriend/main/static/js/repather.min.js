const mainElement = document.getElementById("main");
const styleCss = document.getElementById("style");
const loading = document.getElementById("loading-div");
const debug = true;

let startPage = "main";
let up = true;
let maxPrice = 0;
let minPrice = 0;

setTimeout(()=>{loading.style.display="none";loading.classList.remove("attenuation-class")}, 1000);
function updatePage(page){

    const jsonPage = new XMLHttpRequest();
    jsonPage.open('GET', "/getpage?page="+page);
    jsonPage.onload = () => {
        if(jsonPage.status == 200 && JSON.parse(jsonPage.responseText)["status"] == "successfully"){
            let responce = JSON.parse(jsonPage.responseText);
            mainElement.innerHTML = responce["html"];
            styleCss.innerHTML = responce["css"];
            const mainLinkButton = document.getElementById("main-page-link");
            const aboutasLinkButton = document.getElementById("aboutas-page-link");
            const servicesLinkButton = document.getElementById("services-page-link");
            const reviewsLinkButton = document.getElementById("reviews-page-link");

            mainLinkButton.addEventListener("click", (event)=>{updatePage("main")});
            aboutasLinkButton.addEventListener("click", (event)=>{updatePage("aboutas")});
            servicesLinkButton.addEventListener("click", (event)=>{updatePage("services")});
            reviewsLinkButton.addEventListener("click", (event)=>{updatePage("reviews")});
            if(page == "services"){
                loadServices("minToMaxPrice", start=true);
            }else if (page == "reviews"){
                reviewsShow();
            }
            setTimeout(()=>{
                loading.classList.remove("appearance-class");
                loading.classList.add("attenuation-class");
                loading.style.display="none";
            }, 1000);
        }else if (jsonPage.status != 200){
            alert("Error. Code "+jsonPage.status());
        }else{
            alert("Error. Code "+JSON.parse(jsonPage.responseText)["error"]);
        }
    }
    if (!debug){
        loading.style.display="flex";
        loading.classList.remove("attenuation-class");
        loading.classList.add("appearance-class");
        setTimeout(()=>{jsonPage.send()}, 1000);
    }else{
        jsonPage.send()
    }
}


function loadServices(filter, start, reset){
    const buttonPrice = document.getElementById("button-filter-price");
    const mainServicesElement = document.getElementById("container-services");
    if(reset){
        start = true;
        up = true;
        buttonPrice.innerText = "По возрастанию цены";
        filter = (up ? 'minToMaxPrice' : 'maxToMinPrice');
    }
    let xhrJson = new XMLHttpRequest();
    if (!start){
        const fromPriceElement = document.getElementById("from");
        const beforPriceElement = document.getElementById("to");
        fromPrice = fromPriceElement.value;
        beforPrice = beforPriceElement.value;
        xhrJson.open("GET", "/getpage?page=services&type=services&typefilter="+filter+"&fromPrice="+fromPrice+"&toPrice="+beforPrice);
    }else{
        xhrJson.open("GET", "/getpage?page=services&type=services&typefilter="+filter);
    }
    xhrJson.onload = () => {
        if (xhrJson.status == 200){
            console.log(xhrJson.response);
            let jsonResponce = JSON.parse(xhrJson.response);
            if(jsonResponce["status"] == "successfully"){
                maxPrice = jsonResponce["max"];
                minPrice = jsonResponce["min"];
                mainServicesElement.innerHTML = jsonResponce["html"];
                const fromPriceElement = document.getElementById("from");
                const beforPriceElement = document.getElementById("to");
                console.log(jsonResponce)
                fromPriceElement.value = minPrice;
                beforPriceElement.value = maxPrice;
            }else{
                alert(jsonResponce["error"]);
            }
        }else{
            alert("Error load services");
        }
    }
    xhrJson.send();
}

function priceFilterButtonFunction(){
    const buttonPrice = document.getElementById("button-filter-price");
    if(up){
        buttonPrice.innerText = "По убыванию цены";
    }else{
        buttonPrice.innerText = "По возрастанию цены";
    }
    up = !up;
}

function reviewsShow(){
    const reviewsContainer = document.getElementById("reviews-container");
    let xhrJsonReview = new XMLHttpRequest();
    xhrJsonReview.open("GET", "/getpage?page=reviews&type=reviews");
    xhrJsonReview.onload = () =>{
        if(xhrJsonReview.status == 200){
            let json = JSON.parse(xhrJsonReview.response);
            reviewsContainer.innerHTML = json["html"];
        }
    }
    xhrJsonReview.send();
}

function servicesSign(IDservice){
    const body = document.getElementById("main");
    if (document.getElementsByClassName("services-sign").length != 0){
        return
    }
    let xhrServiceSign = new XMLHttpRequest();
    xhrServiceSign.open("GET", "/getservices?serviceID="+IDservice)
    xhrServiceSign.onload = () =>{
        if (xhrServiceSign.status == 200){
            let jsonResponse = JSON.parse(xhrServiceSign.response);
            if (jsonResponse["status"] == "successfully"){
                console.log(jsonResponse);
                let newSign = jsonResponse["newSign"];
                body.innerHTML += "<div class='services-sign'><button class='btn small_btn' onclick='document.getElementsByClassName(\"services-sign\")[0].remove()'>Закрыть</button><h2>"+jsonResponse["name"]+"</h2><input placeholder='+7(ХХХ)ХХХ-ХХ-ХХ' class='inp big_inp' id='tel' type='tel'><input placeholder='email' class='inp big_inp' id='email' type='email'><input placeholder='Ваше ФИО' class='inp big_inp' id='FCS' type='text'><input placeholder='Имя вашего питомца' class='inp big_inp' id='nameHomi' type='text'><input type='time' id='time-input' min='08:00' max='22:00'/><input type='date' id='date-input' min='"+newSign+"'/><h1>"+jsonResponse["price"]+" р.</h1><button class='btn' onclick='sign(\""+IDservice+"\")'>Записаться</button></div>";
                const mainLinkButton = document.getElementById("main-page-link");
                const aboutasLinkButton = document.getElementById("aboutas-page-link");
                const servicesLinkButton = document.getElementById("services-page-link");
                const reviewsLinkButton = document.getElementById("reviews-page-link");
    
                mainLinkButton.addEventListener("click", (event)=>{updatePage("main")});
                aboutasLinkButton.addEventListener("click", (event)=>{updatePage("aboutas")});
                servicesLinkButton.addEventListener("click", (event)=>{updatePage("services")});
                reviewsLinkButton.addEventListener("click", (event)=>{updatePage("reviews")});
            }else{
                alert(jsonResponse["error"]);
            }
        }else{
            alert("Error getservices by ID "+xhrServiceSign.status);
        }
    };
    xhrServiceSign.send()
}

function sign(ID){
    let xhrSign = new XMLHttpRequest();
    xhrSign.open("POST", "newsign", true)
    xhrSign.onload = () =>{
        if (xhrSign.status == 200){
            let jsonResponse = JSON.parse(xhrSign.response);
            if (jsonResponse["status"] == "successfully"){
                console.log("Registration");
                document.getElementsByClassName("services-sign")[0].innerHTML = "<h1 style='font-family: 'Montserrat';color: white;font-size:3vw;'>Запись сделана</h1>";
                setTimeout(()=>{document.getElementsByClassName("services-sign")[0].remove()}, 5000)
            }else{
                alert(jsonResponse["error"]);
            }
        }
    }
    console.log({phone: document.getElementById("tel").value,
        FCS: document.getElementById("FCS").value, 
        email: document.getElementById("email").value,
        name: document.getElementById("nameHomi").value,
        date: document.getElementById("date-input").value,
        time:document.getElementById("time-input").value,
        ID_string: ID
    });
    xhrSign.send(JSON.stringify({phone: document.getElementById("tel").value,
        FCS: document.getElementById("FCS").value, 
        email: document.getElementById("email").value,
        name: document.getElementById("nameHomi").value,
        date: document.getElementById("date-input").value,
        time:document.getElementById("time-input").value,
        ID_string: ID
    }))
}

updatePage(startPage, true);